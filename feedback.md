2025-09-06 17:46:32,526 - services.gmail_service - DEBUG -    x-bromium-msgid: 65255c6a-d023-4d02-b2d3-59111dc8af9e
2025-09-06 17:46:32,526 - services.gmail_service - DEBUG -    authentication-results: dkim=none (message not signed) header.d=none;dmarc=none action=none header.from=palace.cl;
2025-09-06 17:46:32,526 - services.gmail_service - DEBUG -    x-ms-publictraffictype: Email
2025-09-06 17:46:32,526 - services.gmail_service - DEBUG -    x-ms-traffictypediagnostic: RO2P152MB6215:EE_|RO2P152MB5847:EE_
2025-09-06 17:46:32,526 - services.gmail_service - DEBUG -    x-ms-office365-filtering-correlation-id: a6e40da7-1953-4338-906a-08dded8ec460
2025-09-06 17:46:32,526 - services.gmail_service - DEBUG -    x-ms-exchange-senderadcheck: 1
2025-09-06 17:46:32,526 - services.gmail_service - DEBUG -    x-ms-exchange-antispam-relay: 0
2025-09-06 17:46:32,526 - services.gmail_service - DEBUG -    x-microsoft-antispam: BCL:0;ARA:13230040|1800799024|366016|376014|38070700018|7055299006;
2025-09-06 17:46:32,526 - services.gmail_service - DEBUG -    x-microsoft-antispam-message-info: LfSuSzQjpe5cgRniEHJQYNEkTWANsio+WfTqBuPa+0gzqNxxJKTRLSS9RQN7Dqbe2lZNrUQjBRdy0naRzwaL/fZo6ejtGtGGhfqcy9GUBV9rzn73l8XR356zMwlHHKS4jCY2KM3RHN1lV3uuycGBDxAefFRkdfM070FZwMQCPbAadidrhGChARUDB3SI557IwaR1ROL7+5Zl5IzM+CQ5Umn48yywCqM5k1KV2DIN6AgH5jrRBH1EUf3/0yjZvLPoJSs4cQo5b0HtOVreCxvH/0d3CcJvPGSx8bQAaRZ8gGNbVB8qken6S65f4HNYJZEz8tTHCAs3UjWI196ffemmwRbWz7Cu4/96BRdcF72G5YyZAeuM/Fq339b/1Jk9MCBbgIvi8B6zq5mmlWb0+1c/u3To5CHEsNOUAyUvkKwxKXnVFIh9Xk13azmLYvaE+tyCz90Ch7m6Mh8kqwzNzCHlI1Ppl3Vh3AS9PiIDfU38KLya92krVy0oQN0VpjmWJxA42HZGsfYJgAyy6nsfbCgl1z30zLtihV/AxwJv5gAuXYumLoEvicPW7weyOFhWf1D7MjeVu79/oj4X/+uzOQeBEoHOqxgSsPJLnDw+L1R/RTbyDmTRrxc+n+z4LIajiVzn50HWjLxuckKnpYlTB2g+WeZbt4MIYugZUBQlIl3kET5s+D8wFKFUcAvstFK7wGzHAQjjjARHeAoxWK7HtmQofwPgZQwEwZvXACeIQROwoAGm/UpLBoyK5aFi/YiNYPsEoOdarr0XlBwY91CVdZSVznHSFXK/crO7PjRiRCpEin+llRD/BUWdbmF1Lc0aQBS4IqLCz5iGd58iZ4Iy5zrKJL3Q37uzip7c5ZqBxkEb9PCrxuvT1LONS89nmn0y20yaJ5l1ZjR7Jmv7fbGqzszvGz1+3jbVPZ2CCsX2L/Pa4DvanTbCFqtBM/+wp8t9W6Zrt27CvpfT4EPLiTO/hY1fe/iwmXv76AJrmkpja2OOhTyzTkPqk9871ok5WQda64zBFNEiiozbxOakdKaY8u+K9wLAAT/OdHWux+p1V0mM26rlyua5Bsh//glOFzJDfGLKS+FSuPZlSeCsTNbpyxuSpe9NLuASr3886S+df3+9VWJD5Wy8oggYSCKR7OzHS73vuiH8O5j74fykP16+sNLgHHwzLgcFHMNGygPzGyFUCjWL1pqB5VVn3lpBTLV11EHe4pYkAhmy4e4DiSRhBcYUfrYa6qhkIKWBlSj9sn/7UESORCPiQw9CgJmRPrkMtsPB8FyYDwvBFhv03YaH4HLXfrT2fXZktLEs8pLmmofx69fHOSrCLnS4rp80by8EWjQQfDfoQr+NLg14B9rBEIUn4eq7ngAR0ilGl0Cz+uRZJkY8R3u9RSPJywSZpiIfjnHY8XFZE2Ld++zFG2mzClkl6MhMB5E5ZqWd2R0vOO9d7tSzhMA3GXpVMK63uZBvyPmAmqAYmsGQvsYbO8+nwqJRSLvLNjcUmH5M87R/gdDEq0h2BU6TqPgddyvLtCZ6DtgV
2025-09-06 17:46:32,526 - services.gmail_service - DEBUG -    x-forefront-antispam-report: CIP:255.255.255.255;CTRY:;LANG:es;SCL:1;SRV:;IPV:NLI;SFV:NSPM;H:RO2P152MB6215.LAMP152.PROD.OUTLOOK.COM;PTR:;CAT:NONE;SFS:(13230040)(1800799024)(366016)(376014)(38070700018)(7055299006);DIR:OUT;SFP:1102;
2025-09-06 17:46:32,526 - services.gmail_service - DEBUG -    x-ms-exchange-antispam-messagedata-chunkcount: 1
2025-09-06 17:46:32,526 - services.gmail_service - DEBUG -    x-ms-exchange-antispam-messagedata-0: WBvmRmSccJ1pFXeqW07V/x3OuidQFTFrJaPi48bAKhDl6wdPbfKO2SUbQhtAj4NJGRmnWHzQDqyIKWK+UdbAjrbbkHFuS0YZqgipYypvDydmrXH7lgFQ9fXiF2BlXh0oeDu7KZR8OIP818E59GxOVl6362MjBP9DL4F95Rs3ocFkPWoCSxT7/1Ui5H291VxCg1fg8825GFzPhz5de3neKZvigyl8YAbgJ5tpFjdhLOmI8cCQXQ/yz63tQ6VQ95pmySkgJmrEMwbDZ7PnwMYPEcRCPSE1KJCfVxo/pckvgC2tOI6qC+8Cx6VC6kX2TytfvBno9ssS/aWma4tuw3YZLPFbrCidmLd9lCaUN1eqklCkinjAztLWsfuUUOlRZRNiElzTICXx2V7YnOZ46b5QbENYP3VykOmnt96xm65IOY0LQNi6IR+elhL/6hFm04ZXO4oeQKItqqj2TVxYp3qfRr4Sq+BH2seM94P0owglM8dS1DpqERxiE7Ig2DCBouspK6SDvT4Tezn3JNmpQVPQnjsuyAiluY/q8YQkhl2bkdnZ0wpncH5hIw5IXTfsHI1vzZZ8TNf5bKkEZjOx8f9HQ9CwNSjBGTKOft/4Y7VrOSfCp5QaeM9Oj7b018deGepN8xnCHCrYcdsEuVMujgyAjQuLH+D8StMJOkagnl3qEWybXs2OqlD53F50LPgzcu5tZvJKKuj+QwBlsnCecp8khSqMPbik7/ID1hdznXPWSD0cKgp5J8sQZ1Xz6iOaWEOJZtAkN7Ylukf6dwlxhlLRCCQAZkXeUyhORbS64ByFZT1MjqIr4G0TXCidm4C8l+hcYT4U0BSnT1e/W+S+i7IbsO3UY33e4MqOeufGDTdN2jrTLlnqLCgY9o9+m8wfaXdj9vahchLTBKIVsn5IJH6qMpaqbpzvuXMd/EYRFEEtd+GSvE4o8lYh50C89Gs5JZhF2SjTO4bta7+cah64eIyYv0oeOovdNDIl3D/TxYMQk7lGgrM9H3p4j1+Dqfv7J+pRXWu8j44eO1PPQuljGQnSlnRhyhQ7vA3cAlALxgwx6Iuhq9ZNqbZ1dO1dnGm6SzeIAs/cuq7RPEtU6L5f7qUMWudrD5vJx8K++5bmpkQqEsmIGzs0AR8IYjL9R+1WLmz4f7a6r0zDkkQIbEYqppGOzWZXYu8lDm59Mcj/CIm+hUOHIOmSeTIwmtZukvLbT1eanDv4xj6EnRFjlgDMX0drKpk3Po3yY//3x/F8exytiY/xjCula0MbD2/vYGbiRlva0e3L0p6TM7m4PJKVaaOgPtWq3+DfQyC3JouIafkgG3gjnzh2WMIxT79nv5lLkz5H1fsp/eOOCwdi6wBhkstdhtk3MhlUyWaNa9pOCec3DIAUohb6w+wvrLEr8fBgyrYoBuegX4SGE4a6pnevqB2PQobTFJEChJ8IiWdX3X0gk7WRm8ebgH5LnEgAe+bv1YfdQbU05JOWPL3h/hjIi+XF3JXKk1kRtxUl3BwtwbYcna8BvPSL2+JEVRq7wds6PXnMsVLb6M4iQst4T4eO7Vx6eLb0Gmidm5s1krp15Jw7jprpdwq9sYTmLRHrUVKFGs82
2025-09-06 17:46:32,526 - services.gmail_service - DEBUG -    Content-Type: text/plain; charset="utf-8"
2025-09-06 17:46:32,526 - services.gmail_service - DEBUG -    Content-Transfer-Encoding: base64
2025-09-06 17:46:32,526 - services.gmail_service - DEBUG -    MIME-Version: 1.0
2025-09-06 17:46:32,526 - services.gmail_service - DEBUG -    X-OriginatorOrg: palace.cl
2025-09-06 17:46:32,526 - services.gmail_service - DEBUG -    X-MS-Exchange-CrossTenant-AuthAs: Internal
2025-09-06 17:46:32,526 - services.gmail_service - DEBUG -    X-MS-Exchange-CrossTenant-AuthSource: RO2P152MB6215.LAMP152.PROD.OUTLOOK.COM
2025-09-06 17:46:32,526 - services.gmail_service - DEBUG -    X-MS-Exchange-CrossTenant-Network-Message-Id: a6e40da7-1953-4338-906a-08dded8ec460
2025-09-06 17:46:32,526 - services.gmail_service - DEBUG -    X-MS-Exchange-CrossTenant-originalarrivaltime: 06 Sep 2025 21:45:59.2140 (UTC)
2025-09-06 17:46:32,526 - services.gmail_service - DEBUG -    X-MS-Exchange-CrossTenant-fromentityheader: Hosted
2025-09-06 17:46:32,526 - services.gmail_service - DEBUG -    X-MS-Exchange-CrossTenant-id: 0e28ad13-a043-45fd-8f2a-94a40eeab525
2025-09-06 17:46:32,526 - services.gmail_service - DEBUG -    X-MS-Exchange-CrossTenant-mailboxtype: HOSTED
2025-09-06 17:46:32,526 - services.gmail_service - DEBUG -    X-MS-Exchange-CrossTenant-userprincipalname: YTPBHuG264t42ntPk279TsxQtrXOP/MPMn/RQn+O779MQJMeS2CHbfCEV1/YM7fMZf8F0pAyZgyr7ejLHuUw7w==
2025-09-06 17:46:32,526 - services.gmail_service - DEBUG -    X-MS-Exchange-Transport-CrossTenantHeadersStamped: RO2P152MB5847
2025-09-06 17:46:32,526 - services.gmail_service - INFO - üìß Processing message 19920fe63caba9d1:
2025-09-06 17:46:32,532 - services.gmail_service - INFO -    From: Ben Clark <ben.clark@palace.cl>
2025-09-06 17:46:32,532 - services.gmail_service - INFO -    Subject: FW: Confirmaci√≥n operaci√≥n 9239834
2025-09-06 17:46:32,532 - services.gmail_service - INFO -    To: "admin@xyz.cl" <admin@xyz.cl>
2025-09-06 17:46:32,532 - services.gmail_service - INFO -    CC: "confirmaciones_dev@servicios.palace.cl" <confirmaciones_dev@servicios.palace.cl>
2025-09-06 17:46:32,533 - services.gmail_service - INFO - ‚úÖ Email found in confirmaciones_dev@servicios.palace.cl inbox (was sent via To, CC, or BCC)
2025-09-06 17:46:32,533 - services.gmail_service - INFO - üîç Determining client ID for message 19920fe63caba9d1...
2025-09-06 17:46:32,533 - services.gmail_service - INFO - Client email identified from To/CC: admin@xyz.cl
C:\Users\bencl\Proyectos\ccm2.0\backend\venv\Lib\site-packages\google\cloud\firestore_v1\base_collection.py:295: UserWarning: Detected filter using positional arguments. Prefer using the 'filter' keyword argument instead.
  return query.where(field_path, op_string, value)
2025-09-06 17:46:32,674 - google.auth.transport.requests - DEBUG - Making request: POST https://oauth2.googleapis.com/token
2025-09-06 17:46:32,682 - urllib3.connectionpool - DEBUG - Starting new HTTPS connection (1): oauth2.googleapis.com:443
2025-09-06 17:46:32,857 - urllib3.connectionpool - DEBUG - https://oauth2.googleapis.com:443 "POST /token HTTP/1.1" 200 None
2025-09-06 17:46:32,947 - services.gmail_service - INFO - ‚úÖ Found client 'xyz-corp' for email admin@xyz.cl
2025-09-06 17:46:32,947 - services.gmail_service - INFO - ‚úÖ Client ID determined: xyz-corp
2025-09-06 17:46:32,947 - services.gmail_service - INFO - üìé Extracting attachments from message 19920fe63caba9d1...
2025-09-06 17:46:32,947 - services.gmail_service - DEBUG - Starting attachment extraction for message 19920fe63caba9d1
2025-09-06 17:46:32,947 - services.gmail_service - DEBUG - Processing part: mimeType=text/plain, body=dict_keys(['size', 'data'])
2025-09-06 17:46:32,947 - services.gmail_service - DEBUG - Found Content-Type: text/plain; charset="utf-8"
2025-09-06 17:46:32,947 - services.gmail_service - DEBUG - Found 0 potential PDF attachments
2025-09-06 17:46:32,947 - services.gmail_service - DEBUG - Successfully extracted 0 PDF attachments
2025-09-06 17:46:32,947 - services.gmail_service - INFO - üìß No PDF attachments found, processing email body for 19920fe63caba9d1
2025-09-06 17:46:32,947 - services.gmail_service - INFO - üìù Email body length: 1131 characters
2025-09-06 17:46:33,410 - httpx - DEBUG - load_ssl_context verify=True cert=None trust_env=True http2=False
2025-09-06 17:46:33,410 - httpx - DEBUG - load_verify_locations cafile='C:\\Users\\bencl\\Proyectos\\ccm2.0\\backend\\venv\\Lib\\site-packages\\certifi\\cacert.pem'
2025-09-06 17:46:33,744 - services.llm_service - INFO - Anthropic client methods: ['AI_PROMPT', 'HUMAN_PROMPT', 'api_key', 'auth_headers', 'auth_token', 'base_url', 'beta', 'close', 'completions', 'copy', 'custom_auth', 'default_headers', 'default_query', 'delete', 'get', 'get_api_list', 'is_closed', 'max_retries', 'messages', 'patch', 'platform_headers', 'post', 'put', 'qs', 'request', 'timeout', 'user_agent', 'with_options', 'with_raw_response', 'with_streaming_response']
2025-09-06 17:46:33,744 - services.llm_service - INFO - Anthropic Claude client initialized successfully
2025-09-06 17:46:33,750 - services.client_service - INFO - üìù Processing email body with LLM (1131 chars)
2025-09-06 17:46:33,750 - services.llm_service - INFO - Calling Anthropic Claude model: claude-sonnet-4-20250514
2025-09-06 17:46:33,750 - services.llm_service - INFO - Using Anthropic Messages API
2025-09-06 17:46:33,752 - anthropic._base_client - DEBUG - Request options: {'method': 'post', 'url': '/v1/messages', 'timeout': 600, 'files': None, 'json_data': {'max_tokens': 4000, 'messages': [{'role': 'user', 'content': 'You are receiving an email from a bank. This email is likely to be about a trade confirmation.\n        \n                Tell me if this email is requesting the confirmation of a trade(s) or not. It could feasibly be about something else.\n\n                \nEmail Subject: FW: Confirmaci√≥n operaci√≥n 9239834\nEmail Sender: Ben Clark <ben.clark@palace.cl>\nEmail Body:\nEstimados se√±ores,\r\nSe ha negociado entre Banco ABC y Empresas ABC Limitada la siguiente operaci√≥n de monedas:\r\n1. Tipo de Operaci√≥n:\tSeguro de Cambio\r\n2. Operador:\tJuan P√©rez\r\n3. Moneda Extranjera de Referencia:\tUSD\r\n4. Cantidad Moneda Extranjera de Referencia:\t1.000.000,00\r\n5. Comprador de Seguro de Cambio:\tPalace Investments Limitada\r\n6. Vendedor de Seguro de Cambio:\tBanco ABC\r\n7. Modalidad de Cumplimiento:\tCompensaci√≥n\r\n8. Moneda Compensaci√≥n:\tCLP\r\n9. Fecha de Cierre Operaci√≥n:\t29 septiembre 2025\r\n10. Fecha de Vigencia Operaci√≥n:\t1 octubre 2025\r\n11. Fecha de Vencimiento:\t30 octubre 2025\r\n12. Fecha Valuta de Pago:\t1 noviembre 2025\r\n13. Plazo:\t29 d√≠as\r\n14. Precio Forward:\t932,88\r\n15. Paridad Referencial de Salida:\tUSD OBSERVADO\r\n16. Fecha de Vigencia:\t30 octubre 2025\r\n17. Forma de Pago Cliente:\tLBTR\r\n18. Forma de Pago Banco ABC:\tLBTR\r\n19. Observaciones:\t\r\nEn se√±al de conformidad de las condiciones arriba se√±aladas, agradecemos enviar una copia firmada de esta confirmaci√≥n al e-mail confirmacionesderivados@bancoabc.cl o bien responder el presente correo, entregando vuestra conformidad.\r\nAtentamente,\r\nBanco ABC\t\r\n\n        \n\n                If there is a reference to a trade confirmation, set the Confirmation field to Yes.\n                If there is no reference to a trade confirmation, set the Confirmation field to No.\n\n                The most likely type of emails that we will process are those that request the confirmation of a trade, and they come from banks.\n                \n                Typically (but not always), the subject line of an email about a trade confirmation will include the words "Confirmaci√≥n" or "Confirmation" and the body will also probably refer to a confirmation.\n\n                If this email is indeed about a trade confirmation, you need to extract the data as per the following instructions:\n                \n                Look for the trade number in the subject of the email and in the body. This is usually a number, e.g. "1234567890"). Can also be named as a reference and is one of the most important fields. It will always be present on a confirmation email.\n\n                I also need you to extract some data from the email body. Data in the email body should also override data in the email subject, as it is possible that the conversation\n                has moved on from the initial subject line.\n\n                Remember that this email is written from the Bank\'s perspective, not you, the Client\'s. Therefore, the details of the trade are reversed. Specific consequences of this can include the following:\n                - Counterparty: the bank could refer to you as the counterparty. However, from your perspective, the bank is the counterparty.\n                - Currency 1: the bank could refer to the currency you pay as Currency 1. However, from your perspective, the currency you pay is Currency 2.\n                - Currency 2: the bank could refer to the currency you receive as Currency 2. However, from your perspective, the currency you receive is Currency 1.\n                - Direction: the bank could refer to the direction of the trade as "Buy" or "Sell". However, from your perspective, the direction of the trade is the opposite. Do not be fooled by the direction of the trade, it is the opposite of what the document or emailsays.\n                - Counterparty Payment Method: the bank will refer to the payment method they use as "Forma de Pago Nuestra" or something similar. This should be saved in the field "Counterparty Payment Method".\n                - Our Payment Method: the bank will refer to the payment method you use as "Forma de Pago Contraparte" or something similar. This should be saved in the field "Our Payment Method".\n                \n                The specific data you need to find is as follows:\n                 \n                - Trade Number, a number indicating the ID of the trade, can also be named as a reference. This is usually a number, e.g. "1234567890").\n                - Counterparty ID, typically the bank\'s ID. It may not be present in the email, in which case you should leave it blank.\n                - Counterparty Name, the bank\'s name\n                - Product Type, if this says "Spot", save as "Spot". If it says "Seguro de Cambio", "Seguro de Inflaci√≥n", "Arbitraje", "Forward", "NDF", save as "Forward".\n                - Direction, from your perspective as the client, are you buying from the bank or selling to the bank? Save as "Buy" (if you the client are byuing the base currency and the bank is selling the counter currency) or "Sell" (if you the client are selling the base currency and the bank is buying the counter currency).\n                - Currency 1, an ISO 4217 currency code, the currency you are buying or selling according to the Direction field. Remember if the bank says "Buy", you are selling to the bank (and you should store it as "Sell"), and if the bank says "Sell", you are buying from the bank (and you should store it as "Buy").\n                - Amount of Currency 1, a number, the amount of currency 1 you are buying or selling according to the Direction field.\n                - Currency 2, an ISO 4217 currency code, the other currency of the trade.\n                - Settlement Type, if it says "Compensaci√≥n" or "Non-Deliverable", save as "Compensaci√≥n". If it says "Entrega F√≠sica" or "Deliverable", save as "Entrega F√≠sica".\n                - Settlement Currency, an ISO 4217 currency code. If the Settlement Type is "Entrega F√≠sica", this field is unlikely to exist or have a value, in which case set as "N/A".\n                - Trade Date, a date, which can be in different formats\n                - Value Date, a date, which can be in different formats\n                - Maturity Date, a date, which can be in different formats\n                - Payment Date, a date, which can be in different formats\n                - Duration, an integer number, indicating the number of days between the value date and the maturity date\n                - Forward Price, a number usually with decimal places\n                - Fixing Reference, If you see anything such as "USD Obs", "Dolar Observado", "CLP10", "D√≥lar Observado", "CLP Obs", save as "USD Obs".\n                - Counterparty Payment Method, look in fields labelled "Forma de Pago". Usually one of the following values: "Trans Alto Valor", "ComBanc", "SWIFT", "Cuenta Corriente".\n                - Our Payment Method, look in fields labelled "Forma de Pago". Usually one of the following values: "Trans Alto Valor", "ComBanc", "SWIFT", "Cuenta Corriente"\n\n                Return this in a JSON format, but do not include any markdown formatting such as ```json or ```. This causes errors so I really need you to return it without any markdown formatting.\n                DO NOT return any other text than the JSON, as this causes errors.\n\n                The required structured of the JSON file is as follows:\n\n                {\n                    "Email": {\n                        "EmailSubject": string,\n                        "EmailSender": string,\n                        "EmailDate": date (dd-mm-yyyy),\n                        "EmailTime": time (hh:mm:ss),\n                        "Confirmation": string (Yes or No)\n                        "Num_trades": integer (the number of trades referred to in the email),\n                    },\n                    "Trades": [\n                        {\n                            "BankTradeNumber": string,\n                            "CounterpartyName": string,\n                            "ProductType": string,\n                            "Direction": string ("Buy" or "Sell"),\n                            "Currency1": string (ISO 4217 currency code),\n                            "QuantityCurrency1": number to a minimum of two decimal places,\n                            "Currency2": string (ISO 4217 currency code),\n                            "SettlementType": string, ("Compensaci√≥n" or "Entrega F√≠sica"),\n                            "SettlementCurrency": string (ISO 4217 currency code),\n                            "TradeDate": date in format dd-mm-yyyy,\n                            "ValueDate": date in format dd-mm-yyyy,\n                            "MaturityDate": date in format dd-mm-yyyy,\n                            "PaymentDate": date in format dd-mm-yyyy,\n                            "Price": number to a minimum of two decimal places,\n                            "FixingReference": string,\n                            "CounterpartyPaymentMethod": string,\n                            "OurPaymentMethod": string\n                        }\n                        // Repeat as many times as there are trades in the email\n                    ]\n                }\n\n                Now STOP for a minute, before you return the JSON. I need you to compare the data you have extracted into the Trades array in the JSON with the data in the email. If there is any difference on a specific field, overwrite the data in the JSON with the data you think is correct in the email.\n                \n                I repeat, the email body is the best source of truth.\n\n                If the Direction field is "Buy", then QuantityCurrency1 is the amount of currency 1 you are buying from the bank. If the Direction field is "Sell", then QuantityCurrency1 is the amount of currency 1 you are selling to the bank.\n\n                DO NOT return any other text than the JSON, as this causes errors. NO MARKDOWN.\n            '}], 'model': 'claude-sonnet-4-20250514', 'temperature': 0.1}}
2025-09-06 17:46:33,767 - anthropic._base_client - DEBUG - Sending HTTP Request: POST https://api.anthropic.com/v1/messages
2025-09-06 17:46:33,774 - httpcore.connection - DEBUG - connect_tcp.started host='api.anthropic.com' port=443 local_address=None timeout=600 socket_options=None
2025-09-06 17:46:33,840 - httpcore.connection - DEBUG - connect_tcp.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000001F83D73D150>
2025-09-06 17:46:33,841 - httpcore.connection - DEBUG - start_tls.started ssl_context=<ssl.SSLContext object at 0x000001F83D7E28D0> server_hostname='api.anthropic.com' timeout=600
2025-09-06 17:46:33,874 - httpcore.connection - DEBUG - start_tls.complete return_value=<httpcore._backends.sync.SyncStream object at 0x000001F83D70FD90>
2025-09-06 17:46:33,874 - httpcore.http11 - DEBUG - send_request_headers.started request=<Request [b'POST']>
2025-09-06 17:46:33,874 - httpcore.http11 - DEBUG - send_request_headers.complete
2025-09-06 17:46:33,874 - httpcore.http11 - DEBUG - send_request_body.started request=<Request [b'POST']>
2025-09-06 17:46:33,874 - httpcore.http11 - DEBUG - send_request_body.complete
2025-09-06 17:46:33,874 - httpcore.http11 - DEBUG - receive_response_headers.started request=<Request [b'POST']>
2025-09-06 17:46:38,760 - httpcore.http11 - DEBUG - receive_response_headers.complete return_value=(b'HTTP/1.1', 200, b'OK', [(b'Date', b'Sat, 06 Sep 2025 21:46:38 GMT'), (b'Content-Type', b'application/json'), (b'Transfer-Encoding', b'chunked'), (b'Connection', b'keep-alive'), (b'Content-Encoding', b'gzip'), (b'anthropic-ratelimit-input-tokens-limit', b'450000'), (b'anthropic-ratelimit-input-tokens-remaining', b'449000'), (b'anthropic-ratelimit-input-tokens-reset', b'2025-09-06T21:46:34Z'), (b'anthropic-ratelimit-output-tokens-limit', b'90000'), (b'anthropic-ratelimit-output-tokens-remaining', b'90000'), (b'anthropic-ratelimit-output-tokens-reset', b'2025-09-06T21:46:38Z'), (b'anthropic-ratelimit-requests-limit', b'1000'), (b'anthropic-ratelimit-requests-remaining', b'999'), (b'anthropic-ratelimit-requests-reset', b'2025-09-06T21:46:33Z'), (b'anthropic-ratelimit-tokens-limit', b'540000'), (b'anthropic-ratelimit-tokens-remaining', b'539000'), (b'anthropic-ratelimit-tokens-reset', b'2025-09-06T21:46:34Z'), (b'request-id', b'req_011CSst3kfksA6Yyb1vwXduR'), (b'strict-transport-security', b'max-age=31536000; includeSubDomains; preload'), (b'anthropic-organization-id', b'b8585704-6fcc-4ad5-8159-d65c56696cc2'), (b'x-envoy-upstream-service-time', b'4664'), (b'via', b'1.1 google'), (b'cf-cache-status', b'DYNAMIC'), (b'X-Robots-Tag', b'none'), (b'Server', b'cloudflare'), (b'CF-RAY', b'97b128e87dcbe7ac-SCL')])
2025-09-06 17:46:38,760 - httpx - INFO - HTTP Request: POST https://api.anthropic.com/v1/messages "HTTP/1.1 200 OK"
2025-09-06 17:46:38,760 - httpcore.http11 - DEBUG - receive_response_body.started request=<Request [b'POST']>
2025-09-06 17:46:38,766 - httpcore.http11 - DEBUG - receive_response_body.complete
2025-09-06 17:46:38,766 - httpcore.http11 - DEBUG - response_closed.started
2025-09-06 17:46:38,766 - httpcore.http11 - DEBUG - response_closed.complete
2025-09-06 17:46:38,766 - anthropic._base_client - DEBUG - HTTP Response: POST https://api.anthropic.com/v1/messages "200 OK" Headers({'date': 'Sat, 06 Sep 2025 21:46:38 GMT', 'content-type': 'application/json', 'transfer-encoding': 'chunked', 'connection': 'keep-alive', 'content-encoding': 'gzip', 'anthropic-ratelimit-input-tokens-limit': '450000', 'anthropic-ratelimit-input-tokens-remaining': '449000', 'anthropic-ratelimit-input-tokens-reset': '2025-09-06T21:46:34Z', 'anthropic-ratelimit-output-tokens-limit': '90000', 'anthropic-ratelimit-output-tokens-remaining': '90000', 'anthropic-ratelimit-output-tokens-reset': '2025-09-06T21:46:38Z', 'anthropic-ratelimit-requests-limit': '1000', 'anthropic-ratelimit-requests-remaining': '999', 'anthropic-ratelimit-requests-reset': '2025-09-06T21:46:33Z', 'anthropic-ratelimit-tokens-limit': '540000', 'anthropic-ratelimit-tokens-remaining': '539000', 'anthropic-ratelimit-tokens-reset': '2025-09-06T21:46:34Z', 'request-id': 'req_011CSst3kfksA6Yyb1vwXduR', 'strict-transport-security': 'max-age=31536000; includeSubDomains; preload', 'anthropic-organization-id': 'b8585704-6fcc-4ad5-8159-d65c56696cc2', 'x-envoy-upstream-service-time': '4664', 'via': '1.1 google', 'cf-cache-status': 'DYNAMIC', 'x-robots-tag': 'none', 'server': 'cloudflare', 'cf-ray': '97b128e87dcbe7ac-SCL'})
2025-09-06 17:46:38,766 - anthropic._base_client - DEBUG - request_id: req_011CSst3kfksA6Yyb1vwXduR
2025-09-06 17:46:38,766 - services.llm_service - INFO - Anthropic API call successful
2025-09-06 17:46:38,766 - services.client_service - INFO - üîÑ Calling unified process_and_match_email method for email body
2025-09-06 17:46:38,766 - services.client_service - INFO - Processing email data for client xyz-corp:
2025-09-06 17:46:38,772 - services.client_service - INFO -   Email metadata: {'sender_email': 'Ben Clark <ben.clark@palace.cl>', 'subject': 'FW: Confirmaci√≥n operaci√≥n 9239834', 'body_content': 'Estimados se√±ores,\r\nSe ha negociado entre Banco ABC y Empresas ABC Limitada la siguiente operaci√≥n de monedas:\r\n1. Tipo de Operaci√≥n:\tSeguro de Cambio\r\n2. Operador:\tJuan P√©rez\r\n3. Moneda Extranjera de Referencia:\tUSD\r\n4. Cantidad Moneda Extranjera de Referencia:\t1.000.000,00\r\n5. Comprador de Seguro de Cambio:\tPalace Investments Limitada\r\n6. Vendedor de Seguro de Cambio:\tBanco ABC\r\n7. Modalidad de Cumplimiento:\tCompensaci√≥n\r\n8. Moneda Compensaci√≥n:\tCLP\r\n9. Fecha de Cierre Operaci√≥n:\t29 septiembre 2025\r\n10. Fecha de Vigencia Operaci√≥n:\t1 octubre 2025\r\n11. Fecha de Vencimiento:\t30 octubre 2025\r\n12. Fecha Valuta de Pago:\t1 noviembre 2025\r\n13. Plazo:\t29 d√≠as\r\n14. Precio Forward:\t932,88\r\n15. Paridad Referencial de Salida:\tUSD OBSERVADO\r\n16. Fecha de Vigencia:\t30 octubre 2025\r\n17. Forma de Pago Cliente:\tLBTR\r\n18. Forma de Pago Banco ABC:\tLBTR\r\n19. Observaciones:\t\r\nEn se√±al de conformidad de las condiciones arriba se√±aladas, agradecemos enviar una copia firmada de esta confirmaci√≥n al e-mail confirmacionesderivados@bancoabc.cl o bien responder el presente correo, entregando vuestra conformidad.\r\nAtentamente,\r\nBanco ABC\t\r\n', 'date': 'Sat, 6 Sep 2025 21:45:59 +0000', 'time': '17:46:32', 'attachments_text': ''}
2025-09-06 17:46:38,772 - services.client_service - INFO -   LLM extracted data: {'Email': {'EmailSubject': 'FW: Confirmaci√≥n operaci√≥n 9239834', 'EmailSender': 'Ben Clark <ben.clark@palace.cl>', 'EmailDate': '', 'EmailTime': '', 'Confirmation': 'Yes', 'Num_trades': 1}, 'Trades': [{'BankTradeNumber': '9239834', 'CounterpartyName': 'Banco ABC', 'ProductType': 'Forward', 'Direction': 'Buy', 'Currency1': 'USD', 'QuantityCurrency1': 1000000.0, 'Currency2': 'CLP', 'SettlementType': 'Compensaci√≥n', 'SettlementCurrency': 'CLP', 'TradeDate': '29-09-2025', 'ValueDate': '01-10-2025', 'MaturityDate': '30-10-2025', 'PaymentDate': '01-11-2025', 'Price': 932.88, 'FixingReference': 'USD Obs', 'CounterpartyPaymentMethod': 'LBTR', 'OurPaymentMethod': 'LBTR'}]}
2025-09-06 17:46:38,866 - services.client_service - INFO - Saved email confirmation l8a40QL2N1VBdIqM1bw5 for client xyz-corp
2025-09-06 17:46:38,868 - services.client_service - INFO - Email processing - Trades: 1, Confirmation: True
2025-09-06 17:46:38,868 - services.client_service - INFO - Auto-triggering matching for email_body_Ben Clark <ben.clark.txt with 1 trades
2025-09-06 17:46:38,868 - services.matching_service - INFO - MatchingService initialized
2025-09-06 17:46:38,957 - services.client_service - INFO - Retrieved 10 total trades for client xyz-corp
2025-09-06 17:46:38,962 - services.client_service - INFO - Found 10 unmatched trades for matching
2025-09-06 17:46:38,962 - services.matching_service - INFO - Processing email trade: Unknown
2025-09-06 17:46:38,962 - services.matching_service - DEBUG - Matching criteria - Date: 29-09-2025, CCY1: USD, CCY2: CLP, Amount: 1000000.0, Counterparty: Banco ABC
2025-09-06 17:46:38,962 - services.matching_service - DEBUG - Potential match - Trade: 32011, Score: 45, Reasons: ['Trade date: 29-09-2025', 'Currency pair: USD/CLP']
2025-09-06 17:46:38,962 - services.matching_service - DEBUG - Potential match - Trade: 32019, Score: 90, Reasons: ["Counterparty exact: 'Banco ABC'", 'Trade date: 29-09-2025', 'Currency pair: USD/CLP', 'Amount exact: 1000000.00']
2025-09-06 17:46:38,962 - services.matching_service - DEBUG - Potential match - Trade: 32018, Score: 50, Reasons: ["Counterparty exact: 'Banco ABC'", 'Currency pair: USD/CLP']
2025-09-06 17:46:38,962 - services.matching_service - DEBUG - Potential match - Trade: 32014, Score: 40, Reasons: ['Trade date: 29-09-2025', 'Amount exact: 1000000.00']
2025-09-06 17:46:38,962 - services.matching_service - DEBUG - Potential match - Trade: 32013, Score: 90, Reasons: ["Counterparty exact: 'Banco ABC'", 'Trade date: 29-09-2025', 'Currency pair: USD/CLP', 'Amount exact: 1000000.00']
2025-09-06 17:46:38,962 - services.matching_service - INFO - Match found - Trade: 32019, Score: 90, Confidence: 100%, Status: Confirmation OK, Match ID: 1f34118d-65c5-48ed-a68c-d01b8f07e705
2025-09-06 17:46:38,962 - services.client_service - INFO - üîç Checking for existing match: client_id=xyz-corp, trade_id=NWOCn1SqL3Nzi6UUAee2, trade_number=32019
2025-09-06 17:46:38,962 - services.client_service - DEBUG - üîé Querying matches collection: clients/xyz-corp/matches where tradeId==NWOCn1SqL3Nzi6UUAee2
2025-09-06 17:46:39,047 - services.client_service - DEBUG - üîé Query returned 0 documents
2025-09-06 17:46:39,047 - services.client_service - DEBUG - ‚úÖ No existing match found for trade NWOCn1SqL3Nzi6UUAee2
2025-09-06 17:46:39,047 - services.client_service - INFO - üîç Existing match result: None
2025-09-06 17:46:39,047 - services.client_service - INFO - üÜï No existing match found - Creating new match for trade 32019
2025-09-06 17:46:39,047 - services.client_service - INFO - üìù Creating new match: client_id=xyz-corp, trade_id=NWOCn1SqL3Nzi6UUAee2, email_id=l8a40QL2N1VBdIqM1bw5, confidence=100%, match_id=1f34118d-65c5-48ed-a68c-d01b8f07e705, bank_trade_number=9239834
2025-09-06 17:46:39,047 - services.client_service - DEBUG - üìù Match document to create: {'matchId': '1f34118d-65c5-48ed-a68c-d01b8f07e705', 'tradeId': 'NWOCn1SqL3Nzi6UUAee2', 'emailId': 'l8a40QL2N1VBdIqM1bw5', 'confidenceScore': 100, 'matchReasons': ["Counterparty exact: 'Banco ABC'", 'Trade date: 29-09-2025', 'Currency pair: USD/CLP', 'Amount exact: 1000000.00'], 'status': 'confirmed', 'createdAt': datetime.datetime(2025, 9, 6, 17, 46, 39, 47333), 'organizationId': 'xyz-corp'}
2025-09-06 17:46:39,140 - services.client_service - INFO - ‚úÖ Successfully created match with ID: n9BAwrOhjl9HjIpdU814 in collection clients/xyz-corp/matches
2025-09-06 17:46:39,436 - services.client_service - INFO - ‚úÖ Added match_id 1f34118d-65c5-48ed-a68c-d01b8f07e705 and status 'Confirmation OK' to trade 9239834 in email l8a40QL2N1VBdIqM1bw5
2025-09-06 17:46:39,524 - services.client_service - INFO - Successfully updated email l8a40QL2N1VBdIqM1bw5 trade 9239834 with match_id 1f34118d-65c5-48ed-a68c-d01b8f07e705 and status 'Confirmation OK'
2025-09-06 17:46:39,571 - services.client_service - INFO - Trade matched perfectly - checking confirmation email automation
2025-09-06 17:46:39,571 - services.client_service - INFO - Scheduling confirmation email with 0 second delay (0 minutes)
2025-09-06 17:46:39,571 - services.auto_email_service - INFO - üìß Scheduling confirmation email for client xyz-corp with 0s delay
2025-09-06 17:46:39,737 - services.auto_email_service - INFO - Using CC emails for confirmed trades: ben.clark@palace.cl, ben.clark.15@hotmail.com
2025-09-06 17:46:39,737 - services.auto_email_service - INFO - üè¶ Checking auto-settlement settings for client xyz-corp
2025-09-06 17:46:39,817 - services.auto_email_service - INFO - BC2: Auto-settlement settings for client xyz-corp: {'display': {'language': 'es', 'theme': 'light', 'timezone': 'America/Santiago', 'currency': 'CLP'}, 'alerts': {'emailConfirmedTrades': {'enabled': True, 'emails': ['ben.clark@palace.cl', 'ben.clark.15@hotmail.com']}, 'smsConfirmedTrades': {'enabled': False, 'phones': ['+56977997769']}, 'smsDisputedTrades': {'enabled': False, 'phones': ['+56972133658']}, 'emailDisputedTrades': {'enabled': True, 'emails': ['disputes@palace.cl', 'ben.clark@palace.cl']}}, 'lastUpdatedBy': <google.cloud.firestore_v1.document.DocumentReference object at 0x000001F83D72C450>, 'automation': {'autoCartaInstruccion': True, 'autoConfirmMatched': {'enabled': True, 'delayMinutes': 0}, 'dataSharing': True, 'autoConfirmDisputed': {'enabled': True, 'delayMinutes': 0}}, 'lastUpdatedAt': DatetimeWithNanoseconds(2025, 9, 5, 17, 39, 0, 788648, tzinfo=datetime.timezone.utc)}
2025-09-06 17:46:39,817 - services.auto_email_service - INFO - üè¶ Auto-settlement enabled BC: True
2025-09-06 17:46:39,819 - services.auto_email_service - INFO - üè¶ Auto-settlement enabled for client xyz-corp - generating settlement instruction
2025-09-06 17:46:39,989 - config.storage_config - INFO - Attempting to use Application Default Credentials
2025-09-06 17:46:39,989 - google.auth._default - DEBUG - Checking None for explicit credentials as part of auth process...
2025-09-06 17:46:39,989 - google.auth._default - DEBUG - Checking Cloud SDK credentials as part of auth process...
2025-09-06 17:46:42,132 - urllib3.util.retry - DEBUG - Converted retries value: 3 -> Retry(total=3, connect=None, read=None, redirect=None, status=None)
2025-09-06 17:46:42,132 - google.auth.transport.requests - DEBUG - Making request: POST https://oauth2.googleapis.com/token
2025-09-06 17:46:42,132 - urllib3.connectionpool - DEBUG - Starting new HTTPS connection (1): oauth2.googleapis.com:443
2025-09-06 17:46:42,344 - urllib3.connectionpool - DEBUG - https://oauth2.googleapis.com:443 "POST /token HTTP/1.1" 200 None
2025-09-06 17:46:42,352 - urllib3.connectionpool - DEBUG - Starting new HTTPS connection (1): storage.googleapis.com:443
2025-09-06 17:46:42,690 - urllib3.connectionpool - DEBUG - https://storage.googleapis.com:443 "GET /storage/v1/b?maxResults=1&project=ccm-dev-pool&projection=noAcl&prettyPrint=false HTTP/1.1" 200 969
2025-09-06 17:46:42,690 - config.storage_config - INFO - Storage client initialized for project: ccm-dev-pool
2025-09-06 17:46:42,690 - services.settlement_instruction_service - INFO - Settlement Instruction Service initialized with templates dir: C:\Users\bencl\Proyectos\ccm2.0\backend\templates
2025-09-06 17:46:42,696 - config.storage_config - INFO - Attempting to use Application Default Credentials
2025-09-06 17:46:42,696 - google.auth._default - DEBUG - Checking None for explicit credentials as part of auth process...
2025-09-06 17:46:42,697 - google.auth._default - DEBUG - Checking Cloud SDK credentials as part of auth process...
2025-09-06 17:46:44,598 - urllib3.util.retry - DEBUG - Converted retries value: 3 -> Retry(total=3, connect=None, read=None, redirect=None, status=None)
2025-09-06 17:46:44,598 - google.auth.transport.requests - DEBUG - Making request: POST https://oauth2.googleapis.com/token
2025-09-06 17:46:44,598 - urllib3.connectionpool - DEBUG - Starting new HTTPS connection (1): oauth2.googleapis.com:443
2025-09-06 17:46:44,744 - urllib3.connectionpool - DEBUG - https://oauth2.googleapis.com:443 "POST /token HTTP/1.1" 200 None
2025-09-06 17:46:44,752 - urllib3.connectionpool - DEBUG - Starting new HTTPS connection (1): storage.googleapis.com:443
2025-09-06 17:46:45,055 - urllib3.connectionpool - DEBUG - https://storage.googleapis.com:443 "GET /storage/v1/b?maxResults=1&project=ccm-dev-pool&projection=noAcl&prettyPrint=false HTTP/1.1" 200 969
2025-09-06 17:46:45,063 - config.storage_config - INFO - Storage client initialized for project: ccm-dev-pool
2025-09-06 17:46:45,063 - services.settlement_instruction_service - INFO - Settlement Instruction Service initialized with templates dir: C:\Users\bencl\Proyectos\ccm2.0\backend\templates
2025-09-06 17:46:45,063 - services.auto_email_service - INFO - üìÑ DEBUG: email_data keys: ['client_id', 'match_id', 'trade_id', 'email_id', 'email_type', 'comparison_status', 'differing_fields', 'confidence_score', 'bank_trade_number', 'counterparty_name', 'scheduled_at', 'email_trade_data', 'client_trade_data']
2025-09-06 17:46:45,063 - services.auto_email_service - INFO - üìÑ DEBUG: email_trade_data: {'BankTradeNumber': '9239834', 'CounterpartyName': 'Banco ABC', 'ProductType': 'Forward', 'Direction': 'Buy', 'Currency1': 'USD', 'QuantityCurrency1': 1000000.0, 'Currency2': 'CLP', 'SettlementType': 'Compensaci√≥n', 'SettlementCurrency': 'CLP', 'TradeDate': '29-09-2025', 'ValueDate': '01-10-2025', 'MaturityDate': '30-10-2025', 'PaymentDate': '01-11-2025', 'Price': 932.88, 'FixingReference': 'USD Obs', 'CounterpartyPaymentMethod': 'LBTR', 'OurPaymentMethod': 'LBTR'}
2025-09-06 17:46:45,063 - services.auto_email_service - INFO - üìÑ DEBUG: client_trade_data: {'ValueDate': '01-10-2025', 'organizationId': 'xyz-corp', 'ProductType': 'Forward', 'Price': 932.88, 'Direction': 'Buy', 'OurPaymentMethod': 'LBTR', 'MaturityDate': '30-10-2025', 'Currency1': 'USD', 'uploadSessionId': 'KKKTrwEWOzqZPLXw1QDp', 'status': 'unmatched', 'PaymentDate': '01-11-2025', 'updatedAt': DatetimeWithNanoseconds(2025, 9, 6, 17, 35, 55, 278913, tzinfo=datetime.timezone.utc), 'TradeNumber': '32019', 'Currency2': 'CLP', 'TradeDate': '29-09-2025', 'SettlementType': 'Compensaci√≥n', 'FixingReference': 'USD Obs', 'CounterpartyPaymentMethod': 'LBTR', 'createdAt': DatetimeWithNanoseconds(2025, 9, 4, 14, 39, 41, 577032, tzinfo=datetime.timezone.utc), 'CounterpartyName': 'Banco ABC', 'QuantityCurrency1': 1000000.0, 'SettlementCurrency': 'CLP', 'id': 'NWOCn1SqL3Nzi6UUAee2'}
2025-09-06 17:46:45,119 - services.auto_email_service - INFO - üìÑ Generating settlement instruction with bank_id: banco-abc
2025-09-06 17:46:45,252 - services.auto_email_service - INFO - üìã Found 7 settlement rules and 4 bank accounts
2025-09-06 17:46:45,253 - services.auto_email_service - INFO - üîç Matching against counterparty: , product: Forward, currencies: /
2025-09-06 17:46:45,253 - services.auto_email_service - INFO - ‚úÖ Matched settlement rule: Compra USD/CLP Forward Comp CLP
2025-09-06 17:46:45,253 - services.auto_email_service - INFO - üí∞ Settlement data prepared:  / 2011234568
2025-09-06 17:46:45,253 - services.settlement_instruction_service - INFO - üîç Starting settlement instruction generation:
2025-09-06 17:46:45,253 - services.settlement_instruction_service - INFO -    Bank ID: banco-abc
2025-09-06 17:46:45,253 - services.settlement_instruction_service - INFO -    Client segment ID: xyz-corp
2025-09-06 17:46:45,253 - services.settlement_instruction_service - INFO -    Settlement type: Compensaci√≥n
2025-09-06 17:46:45,253 - services.settlement_instruction_service - INFO -    Product: Forward
2025-09-06 17:46:45,253 - services.settlement_instruction_service - INFO - üîç Template search criteria:
2025-09-06 17:46:45,255 - services.settlement_instruction_service - INFO -    Bank ID: 'banco-abc'
2025-09-06 17:46:45,255 - services.settlement_instruction_service - INFO -    Settlement type: 'Compensaci√≥n'
2025-09-06 17:46:45,255 - services.settlement_instruction_service - INFO -    Product: 'Forward'
2025-09-06 17:46:45,255 - services.settlement_instruction_service - INFO -    Client segment ID: 'xyz-corp'
2025-09-06 17:46:45,255 - services.settlement_instruction_service - INFO - üîç Querying database: banks/banco-abc/settlementInstructionLetters
2025-09-06 17:46:45,298 - services.settlement_instruction_service - INFO - ‚úÖ Bank document exists: {'taxId': '96.543.210-K', 'lastUpdatedAt': DatetimeWithNanoseconds(2025, 8, 11, 14, 31, 25, 210000, tzinfo=datetime.timezone.utc), 'country': 'CL', 'createdAt': DatetimeWithNanoseconds(2025, 8, 11, 14, 31, 25, 210000, tzinfo=datetime.timezone.utc), 'lastUpdatedBy': <google.cloud.firestore_v1.document.DocumentReference object at 0x000001F83EBB5350>, 'status': 'active', 'swiftCode': 'ABCCCL22', 'name': 'Banco ABC'}
2025-09-06 17:46:45,360 - services.settlement_instruction_service - INFO - üîç Total settlement instruction letters in banks/banco-abc/settlementInstructionLetters: 3
2025-09-06 17:46:45,360 - services.settlement_instruction_service - INFO - üìã Available templates for bank 'banco-abc':
2025-09-06 17:46:45,360 - services.settlement_instruction_service - INFO -    1. ID: FJ5QzerHGXuTDvmlEWJz
2025-09-06 17:46:45,360 - services.settlement_instruction_service - INFO -       Rule name: Fwd Entrega F√≠sica Template
2025-09-06 17:46:45,360 - services.settlement_instruction_service - INFO -       Settlement type: Entrega F√≠sica
2025-09-06 17:46:45,360 - services.settlement_instruction_service - INFO -       Product: Forward
2025-09-06 17:46:45,361 - services.settlement_instruction_service - INFO -       Client segment: None
2025-09-06 17:46:45,361 - services.settlement_instruction_service - INFO -       Active: True
2025-09-06 17:46:45,361 - services.settlement_instruction_service - INFO -       Priority: 3
2025-09-06 17:46:45,362 - services.settlement_instruction_service - INFO -       Storage path: banco-abc/default/Template Forward Carta Instrucci√≥n Banco ABC (Entrega F√≠sica)_20250904_125440_59c7ba66.docx
2025-09-06 17:46:45,362 - services.settlement_instruction_service - INFO -    2. ID: quMmm8HLMsEggC6xeTNf
2025-09-06 17:46:45,362 - services.settlement_instruction_service - INFO -       Rule name: Spot Entrega F√≠sica Template
2025-09-06 17:46:45,362 - services.settlement_instruction_service - INFO -       Settlement type: Entrega F√≠sica
2025-09-06 17:46:45,362 - services.settlement_instruction_service - INFO -       Product: Spot
2025-09-06 17:46:45,362 - services.settlement_instruction_service - INFO -       Client segment: None
2025-09-06 17:46:45,362 - services.settlement_instruction_service - INFO -       Active: True
2025-09-06 17:46:45,363 - services.settlement_instruction_service - INFO -       Priority: 1
2025-09-06 17:46:45,363 - services.settlement_instruction_service - INFO -       Storage path: banco-abc/default/Template Spot Carta Instrucci√≥n Banco ABC (Entrega F√≠sica)_20250904_121824_9ab57f9d.docx
2025-09-06 17:46:45,363 - services.settlement_instruction_service - INFO -    3. ID: wX8RFw4ynUK7DrBERqiC
2025-09-06 17:46:45,363 - services.settlement_instruction_service - INFO -       Rule name: Fwd Compensaci√≥n Template 2
2025-09-06 17:46:45,363 - services.settlement_instruction_service - INFO -       Settlement type: Compensaci√≥n
2025-09-06 17:46:45,363 - services.settlement_instruction_service - INFO -       Product: Forward
2025-09-06 17:46:45,363 - services.settlement_instruction_service - INFO -       Client segment: None
2025-09-06 17:46:45,364 - services.settlement_instruction_service - INFO -       Active: True
2025-09-06 17:46:45,364 - services.settlement_instruction_service - INFO -       Priority: 2
2025-09-06 17:46:45,364 - services.settlement_instruction_service - INFO -       Storage path: banco-abc/default/Template Forward Carta Instrucci√≥n Banco ABC (Compensaci√≥n)_20250904_125732_4b8e0309.docx
2025-09-06 17:46:45,364 - services.settlement_instruction_service - INFO - üîç Filtering by active=True...
2025-09-06 17:46:45,410 - services.settlement_instruction_service - INFO -    Found 3 active templates
2025-09-06 17:46:45,410 - services.settlement_instruction_service - INFO - üîç Filtering by settlement_type='Compensaci√≥n'...
C:\Users\bencl\Proyectos\ccm2.0\backend\src\services\settlement_instruction_service.py:190: UserWarning: Detected filter using positional arguments. Prefer using the 'filter' keyword argument instead.
  query = query.where('settlement_type', '==', settlement_type)
2025-09-06 17:46:45,458 - services.settlement_instruction_service - INFO -    Found 1 templates matching settlement_type
2025-09-06 17:46:45,517 - services.settlement_instruction_service - INFO - üßÆ Scoring template 'Fwd Compensaci√≥n Template 2':
2025-09-06 17:46:45,517 - services.settlement_instruction_service - INFO -    Settlement type match: +100 ('Compensaci√≥n' == 'Compensaci√≥n')
2025-09-06 17:46:45,519 - services.settlement_instruction_service - INFO -    Product partial match: +50 ('Forward' in 'Forward')
2025-09-06 17:46:45,519 - services.settlement_instruction_service - INFO -    Default template (no client segment): +10
2025-09-06 17:46:45,519 - services.settlement_instruction_service - INFO -    Priority bonus: +998 (priority 2)
2025-09-06 17:46:45,519 - services.settlement_instruction_service - INFO -    Total score: 1158
2025-09-06 17:46:45,519 - services.settlement_instruction_service - INFO - üèÜ Final template ranking:
2025-09-06 17:46:45,519 - services.settlement_instruction_service - INFO -    1. Fwd Compensaci√≥n Template 2 (score: 1158)
2025-09-06 17:46:45,519 - services.settlement_instruction_service - INFO - ‚úÖ Selected best template: Fwd Compensaci√≥n Template 2 (score: 1158)
2025-09-06 17:46:45,520 - services.settlement_instruction_service - INFO - ‚úÖ Found matching template: Fwd Compensaci√≥n Template 2 (ID: wX8RFw4ynUK7DrBERqiC, Score: 1158)
2025-09-06 17:46:45,649 - urllib3.connectionpool - DEBUG - https://storage.googleapis.com:443 "GET /storage/v1/b/ccm-dev-pool-settlement-documents/o/banco-abc%2Fdefault%2FTemplate%20Forward%20Carta%20Instrucci%C3%B3n%20Banco%20ABC%20%28Compensaci%C3%B3n%29_20250904_125732_4b8e0309.docx?fields=name&prettyPrint=false HTTP/1.1" 200 120
2025-09-06 17:46:45,867 - urllib3.connectionpool - DEBUG - https://storage.googleapis.com:443 "GET /download/storage/v1/b/ccm-dev-pool-settlement-documents/o/banco-abc%2Fdefault%2FTemplate%20Forward%20Carta%20Instrucci%C3%B3n%20Banco%20ABC%20%28Compensaci%C3%B3n%29_20250904_125732_4b8e0309.docx?alt=media HTTP/1.1" 200 22264
2025-09-06 17:46:45,900 - services.storage_service - INFO - Successfully downloaded document from banco-abc/default/Template Forward Carta Instrucci√≥n Banco ABC (Compensaci√≥n)_20250904_125732_4b8e0309.docx to C:\Users\bencl\AppData\Local\Temp\template_wX8RFw4ynUK7DrBERqiC_1d02e6e99f8e420d9cde890de1be04ee.docx
2025-09-06 17:46:45,900 - services.settlement_instruction_service - INFO - Template downloaded to: C:\Users\bencl\AppData\Local\Temp\template_wX8RFw4ynUK7DrBERqiC_1d02e6e99f8e420d9cde890de1be04ee.docx
2025-09-06 17:46:45,900 - services.settlement_instruction_service - INFO - ‚úÖ Template downloaded to: C:\Users\bencl\AppData\Local\Temp\template_wX8RFw4ynUK7DrBERqiC_1d02e6e99f8e420d9cde890de1be04ee.docx
2025-09-06 17:46:46,012 - services.settlement_instruction_service - INFO - Settlement instruction generated: C:\Users\bencl\Proyectos\ccm2.0\backend\templates\generated\settlement_instruction_unknown_20250906_174645.docx
2025-09-06 17:46:46,012 - services.settlement_instruction_service - INFO - ‚úÖ Document generated: C:\Users\bencl\Proyectos\ccm2.0\backend\templates\generated\settlement_instruction_unknown_20250906_174645.docx
2025-09-06 17:46:46,012 - services.settlement_instruction_service - INFO - üßπ Cleaned up temporary template file: C:\Users\bencl\AppData\Local\Temp\template_wX8RFw4ynUK7DrBERqiC_1d02e6e99f8e420d9cde890de1be04ee.docx
2025-09-06 17:46:46,015 - config.storage_config - INFO - Attempting to use Application Default Credentials
2025-09-06 17:46:46,015 - google.auth._default - DEBUG - Checking None for explicit credentials as part of auth process...
2025-09-06 17:46:46,015 - google.auth._default - DEBUG - Checking Cloud SDK credentials as part of auth process...
2025-09-06 17:46:48,166 - urllib3.util.retry - DEBUG - Converted retries value: 3 -> Retry(total=3, connect=None, read=None, redirect=None, status=None)
2025-09-06 17:46:48,166 - google.auth.transport.requests - DEBUG - Making request: POST https://oauth2.googleapis.com/token
2025-09-06 17:46:48,168 - urllib3.connectionpool - DEBUG - Starting new HTTPS connection (1): oauth2.googleapis.com:443
2025-09-06 17:46:48,316 - urllib3.connectionpool - DEBUG - https://oauth2.googleapis.com:443 "POST /token HTTP/1.1" 200 None
2025-09-06 17:46:48,316 - urllib3.connectionpool - DEBUG - Starting new HTTPS connection (1): storage.googleapis.com:443
2025-09-06 17:46:48,637 - urllib3.connectionpool - DEBUG - https://storage.googleapis.com:443 "GET /storage/v1/b?maxResults=1&project=ccm-dev-pool&projection=noAcl&prettyPrint=false HTTP/1.1" 200 969
2025-09-06 17:46:48,640 - config.storage_config - INFO - Storage client initialized for project: ccm-dev-pool
2025-09-06 17:46:48,863 - urllib3.connectionpool - DEBUG - https://storage.googleapis.com:443 "POST /upload/storage/v1/b/ccm-dev-pool-settlement-documents/o?uploadType=multipart HTTP/1.1" 200 1776
2025-09-06 17:46:48,863 - services.storage_service - INFO - Successfully uploaded document: xyz-corp/settlement-instructions/SI_9239834_XYZCorporation_BancoABC_20250906_214648_20250906_174648_221a84b5.docx
2025-09-06 17:46:48,863 - google.auth._default - DEBUG - Checking None for explicit credentials as part of auth process...
2025-09-06 17:46:48,863 - google.auth._default - DEBUG - Checking Cloud SDK credentials as part of auth process...
2025-09-06 17:46:50,747 - urllib3.util.retry - DEBUG - Converted retries value: 3 -> Retry(total=3, connect=None, read=None, redirect=None, status=None)
2025-09-06 17:46:50,747 - google.auth.transport.requests - DEBUG - Making request: POST https://oauth2.googleapis.com/token
2025-09-06 17:46:50,747 - urllib3.connectionpool - DEBUG - Starting new HTTPS connection (1): oauth2.googleapis.com:443
2025-09-06 17:46:50,892 - urllib3.connectionpool - DEBUG - https://oauth2.googleapis.com:443 "POST /token HTTP/1.1" 200 None
2025-09-06 17:46:50,892 - urllib3.connectionpool - DEBUG - Starting new HTTPS connection (1): iamcredentials.googleapis.com:443
2025-09-06 17:46:51,105 - urllib3.connectionpool - DEBUG - https://iamcredentials.googleapis.com:443 "POST /v1/projects/-/serviceAccounts/ccm-storage-service@ccm-dev-pool.iam.gserviceaccount.com:signBlob HTTP/1.1" 200 None
2025-09-06 17:46:51,105 - services.auto_email_service - INFO - ‚úÖ Document uploaded to cloud storage: https://storage.googleapis.com/ccm-dev-pool-settlement-documents/xyz-corp/settlement-instructions/SI_9239834_XYZCorporation_BancoABC_20250906_214648_20250906_174648_221a84b5.docx
2025-09-06 17:46:51,105 - services.auto_email_service - INFO - üîç DEBUG: doc_result keys: ['success', 'document_path', 'template_used', 'template_id', 'match_score', 'variables_populated', 'debug_variables', 'generated_at', 'storage_path', 'signed_url']
2025-09-06 17:46:51,105 - services.auto_email_service - INFO - üîç DEBUG: doc_result.success: True
2025-09-06 17:46:51,105 - services.auto_email_service - INFO - üîç DEBUG: doc_result.storage_path: https://storage.googleapis.com/ccm-dev-pool-settlement-documents/xyz-corp/settlement-instructions/SI_9239834_XYZCorporation_BancoABC_20250906_214648_20250906_174648_221a84b5.docx
2025-09-06 17:46:51,105 - services.auto_email_service - INFO - üîç DEBUG: doc_result.signed_url: https://storage.googleapis.com/ccm-dev-pool-settlement-documents/xyz-corp/settlement-instructions/SI_9239834_XYZCorporation_BancoABC_20250906_214648_20250906_174648_221a84b5.docx?X-Goog-Algorithm=GOOG4-RSA-SHA256&X-Goog-Credential=ccm-storage-service%40ccm-dev-pool.iam.gserviceaccount.com%2F20250906%2Fauto%2Fstorage%2Fgoog4_request&X-Goog-Date=20250906T214650Z&X-Goog-Expires=3600&X-Goog-SignedHeaders=host&X-Goog-Signature=32f186fdd6cf000a4a70d57ad0eee82964ae03480e0dfdcbe2f1e3ef7461ae0b5b946932b427311e1466a9bbcda3b56b555ee2a2a530b4e38d5d045ea494daa85e6812a9130373c7ed2f400494ea2509b39f0c8735c154c4745ad2a70d69e7a55b85a756034cb5ff3592c9c4c7131f0a1e1fc83db404393a8f44b6077fd89f47dd554b0f37278f2761fac5ce9a405ab4a92ef78f0e7843baf498820c12109c45c0e6e8d696b03fd04bb053ae07aa39442fb3f487597d2f7f079436e6f76749d4b31426c44950e09daace84e6bc792cc0f58107b693e845005022dc1d4ff21c0bae8c449743243a926ce0afb70c5d0990f466c5c6176a7bcf271165a0feee42bb
2025-09-06 17:46:51,105 - services.auto_email_service - INFO - üîç DEBUG: attachment_info: {'filename': 'settlement_instruction_9239834.docx', 'storage_path': 'https://storage.googleapis.com/ccm-dev-pool-settlement-documents/xyz-corp/settlement-instructions/SI_9239834_XYZCorporation_BancoABC_20250906_214648_20250906_174648_221a84b5.docx', 'signed_url': 'https://storage.googleapis.com/ccm-dev-pool-settlement-documents/xyz-corp/settlement-instructions/SI_9239834_XYZCorporation_BancoABC_20250906_214648_20250906_174648_221a84b5.docx?X-Goog-Algorithm=GOOG4-RSA-SHA256&X-Goog-Credential=ccm-storage-service%40ccm-dev-pool.iam.gserviceaccount.com%2F20250906%2Fauto%2Fstorage%2Fgoog4_request&X-Goog-Date=20250906T214650Z&X-Goog-Expires=3600&X-Goog-SignedHeaders=host&X-Goog-Signature=32f186fdd6cf000a4a70d57ad0eee82964ae03480e0dfdcbe2f1e3ef7461ae0b5b946932b427311e1466a9bbcda3b56b555ee2a2a530b4e38d5d045ea494daa85e6812a9130373c7ed2f400494ea2509b39f0c8735c154c4745ad2a70d69e7a55b85a756034cb5ff3592c9c4c7131f0a1e1fc83db404393a8f44b6077fd89f47dd554b0f37278f2761fac5ce9a405ab4a92ef78f0e7843baf498820c12109c45c0e6e8d696b03fd04bb053ae07aa39442fb3f487597d2f7f079436e6f76749d4b31426c44950e09daace84e6bc792cc0f58107b693e845005022dc1d4ff21c0bae8c449743243a926ce0afb70c5d0990f466c5c6176a7bcf271165a0feee42bb'}
2025-09-06 17:46:51,105 - services.auto_email_service - INFO - üîç DEBUG: email_content.attachments: [{'filename': 'settlement_instruction_9239834.docx', 'storage_path': 'https://storage.googleapis.com/ccm-dev-pool-settlement-documents/xyz-corp/settlement-instructions/SI_9239834_XYZCorporation_BancoABC_20250906_214648_20250906_174648_221a84b5.docx', 'signed_url': 'https://storage.googleapis.com/ccm-dev-pool-settlement-documents/xyz-corp/settlement-instructions/SI_9239834_XYZCorporation_BancoABC_20250906_214648_20250906_174648_221a84b5.docx?X-Goog-Algorithm=GOOG4-RSA-SHA256&X-Goog-Credential=ccm-storage-service%40ccm-dev-pool.iam.gserviceaccount.com%2F20250906%2Fauto%2Fstorage%2Fgoog4_request&X-Goog-Date=20250906T214650Z&X-Goog-Expires=3600&X-Goog-SignedHeaders=host&X-Goog-Signature=32f186fdd6cf000a4a70d57ad0eee82964ae03480e0dfdcbe2f1e3ef7461ae0b5b946932b427311e1466a9bbcda3b56b555ee2a2a530b4e38d5d045ea494daa85e6812a9130373c7ed2f400494ea2509b39f0c8735c154c4745ad2a70d69e7a55b85a756034cb5ff3592c9c4c7131f0a1e1fc83db404393a8f44b6077fd89f47dd554b0f37278f2761fac5ce9a405ab4a92ef78f0e7843baf498820c12109c45c0e6e8d696b03fd04bb053ae07aa39442fb3f487597d2f7f079436e6f76749d4b31426c44950e09daace84e6bc792cc0f58107b693e845005022dc1d4ff21c0bae8c449743243a926ce0afb70c5d0990f466c5c6176a7bcf271165a0feee42bb'}]
2025-09-06 17:46:51,105 - services.auto_email_service - INFO - ‚úÖ Settlement instruction generated and will be attached for trade 9239834
2025-09-06 17:46:51,105 - services.auto_email_service - INFO -    üìé File: settlement_instruction_9239834.docx
2025-09-06 17:46:51,105 - services.auto_email_service - INFO -    üîó Storage: https://storage.googleapis.com/ccm-dev-pool-settlement-documents/xyz-corp/settlement-instructions/SI_9239834_XYZCorporation_BancoABC_20250906_214648_20250906_174648_221a84b5.docx
2025-09-06 17:46:51,105 - services.auto_email_service - INFO - üîç DEBUG: Final email_content before task creation:
2025-09-06 17:46:51,105 - services.auto_email_service - INFO - üîç DEBUG: email_content keys: ['to_email', 'subject', 'body', 'cc_email', 'reply_to', 'trade_number', 'counterparty_name', 'organization_name', 'client_id', 'match_id', 'trade_id', 'email_id', 'email_type', 'comparison_status', 'differing_fields', 'confidence_score', 'scheduled_at', 'attachments']
2025-09-06 17:46:51,105 - services.auto_email_service - INFO - üîç DEBUG: attachments in email_content: [{'filename': 'settlement_instruction_9239834.docx', 'storage_path': 'https://storage.googleapis.com/ccm-dev-pool-settlement-documents/xyz-corp/settlement-instructions/SI_9239834_XYZCorporation_BancoABC_20250906_214648_20250906_174648_221a84b5.docx', 'signed_url': 'https://storage.googleapis.com/ccm-dev-pool-settlement-documents/xyz-corp/settlement-instructions/SI_9239834_XYZCorporation_BancoABC_20250906_214648_20250906_174648_221a84b5.docx?X-Goog-Algorithm=GOOG4-RSA-SHA256&X-Goog-Credential=ccm-storage-service%40ccm-dev-pool.iam.gserviceaccount.com%2F20250906%2Fauto%2Fstorage%2Fgoog4_request&X-Goog-Date=20250906T214650Z&X-Goog-Expires=3600&X-Goog-SignedHeaders=host&X-Goog-Signature=32f186fdd6cf000a4a70d57ad0eee82964ae03480e0dfdcbe2f1e3ef7461ae0b5b946932b427311e1466a9bbcda3b56b555ee2a2a530b4e38d5d045ea494daa85e6812a9130373c7ed2f400494ea2509b39f0c8735c154c4745ad2a70d69e7a55b85a756034cb5ff3592c9c4c7131f0a1e1fc83db404393a8f44b6077fd89f47dd554b0f37278f2761fac5ce9a405ab4a92ef78f0e7843baf498820c12109c45c0e6e8d696b03fd04bb053ae07aa39442fb3f487597d2f7f079436e6f76749d4b31426c44950e09daace84e6bc792cc0f58107b693e845005022dc1d4ff21c0bae8c449743243a926ce0afb70c5d0990f466c5c6176a7bcf271165a0feee42bb'}]
2025-09-06 17:46:51,105 - services.task_queue_service - INFO - Initializing Cloud Tasks client...
2025-09-06 17:46:51,105 - google.auth._default - DEBUG - Checking None for explicit credentials as part of auth process...
2025-09-06 17:46:51,105 - google.auth._default - DEBUG - Checking Cloud SDK credentials as part of auth process...
2025-09-06 17:46:52,975 - services.task_queue_service - INFO - ‚úÖ Cloud Tasks client initialized for project: ccm-dev-pool
2025-09-06 17:46:53,107 - google.auth.transport.requests - DEBUG - Making request: POST https://oauth2.googleapis.com/token
2025-09-06 17:46:53,107 - urllib3.connectionpool - DEBUG - Starting new HTTPS connection (1): oauth2.googleapis.com:443
2025-09-06 17:46:53,238 - urllib3.connectionpool - DEBUG - https://oauth2.googleapis.com:443 "POST /token HTTP/1.1" 200 None
2025-09-06 17:46:53,239 - google.auth.transport.requests - DEBUG - Making request: POST https://iamcredentials.googleapis.com/v1/projects/-/serviceAccounts/cloud-tasks-manager@ccm-dev-pool.iam.gserviceaccount.com:generateAccessToken
2025-09-06 17:46:53,239 - urllib3.connectionpool - DEBUG - Starting new HTTPS connection (1): iamcredentials.googleapis.com:443
2025-09-06 17:46:53,377 - urllib3.connectionpool - DEBUG - https://iamcredentials.googleapis.com:443 "POST /v1/projects/-/serviceAccounts/cloud-tasks-manager@ccm-dev-pool.iam.gserviceaccount.com:generateAccessToken HTTP/1.1" 200 None
2025-09-06 17:46:54,044 - services.task_queue_service - INFO - ‚úÖ Created email_confirmation task: email_confirmation_1757195212_5824 in EMAIL queue
2025-09-06 17:46:54,046 - services.auto_email_service - INFO - ‚úÖ Successfully scheduled confirmation email task: projects/ccm-dev-pool/locations/us-east4/queues/email-tasks/tasks/3740375077205437973
2025-09-06 17:46:54,047 - services.client_service - INFO - ‚úÖ Successfully scheduled confirmation email task: projects/ccm-dev-pool/locations/us-east4/queues/email-tasks/tasks/3740375077205437973
2025-09-06 17:46:54,163 - services.client_service - DEBUG - No SMS sent (may be disabled or no phone numbers configured)
2025-09-06 17:46:54,171 - services.client_service - INFO - Created match between trade NWOCn1SqL3Nzi6UUAee2 and email l8a40QL2N1VBdIqM1bw5 with 100% confidence
2025-09-06 17:46:54,171 - services.client_service - INFO - ‚úÖ Successfully created match for trade 32019 with 100% confidence
2025-09-06 17:46:54,171 - services.client_service - INFO - Email processing complete for email_body_Ben Clark <ben.clark.txt: 1 matches, 0 duplicates
2025-09-06 17:46:54,171 - services.event_service - INFO - üì° Broadcasting event gmail_processed to 0 subscription groups
2025-09-06 17:46:54,171 - services.event_service - INFO - üì° Emitted event: gmail_processed - Email Processed Successfully (client: xyz-corp, priority: medium)
2025-09-06 17:46:54,173 - services.client_service - INFO - üì° Emitted Gmail processing event: Email Processed Successfully
2025-09-06 17:46:54,173 - services.client_service - INFO - ‚úÖ Gmail body processing completed: {'email_id': 'l8a40QL2N1VBdIqM1bw5', 'trades_extracted': 1, 'confirmation_detected': True, 'processed_at': '2025-09-06T17:46:38.868155', 'matches_found': 1, 'matched_trade_numbers': ['32019'], 'duplicates_found': 0, 'counterparty_name': 'Banco ABC', 'matching_attempted': True, 'processing_complete': True}
2025-09-06 17:46:54,173 - services.gmail_service - INFO - ‚úÖ Successfully processed email body from Ben Clark <ben.clark@palace.cl>
2025-09-06 17:46:54,174 - services.gmail_service - INFO - Successfully processed message 19920fe63caba9d1: 1 trades extracted
2025-09-06 17:46:54,174 - services.gmail_service - INFO - ‚úÖ Processed 1 emails in check #5
2025-09-06 17:46:54,175 - services.gmail_service - INFO - üìä Email from Ben Clark <ben.clark@palace.cl>: 1 trades, 1 matches, 0 duplicates
2025-09-06 17:46:54,175 - services.gmail_service - DEBUG - ‚è∞ Waiting 30s until next check...
2025-09-06 17:46:54,294 - services.task_queue_service - INFO - DEBUG: Received headers: {'host': '9d30f9873964.ngrok-free.app', 'user-agent': 'Google-Cloud-Tasks', 'content-length': '2205', 'accept-encoding': 'gzip, deflate, br', 'content-type': 'application/json', 'x-cloudtasks-queuename': 'email-tasks', 'x-cloudtasks-tasketa': '1757195213.739588', 'x-cloudtasks-taskexecutioncount': '0', 'x-cloudtasks-taskname': '3740375077205437973', 'x-cloudtasks-taskretrycount': '0', 'x-forwarded-for': '34.98.136.133', 'x-forwarded-host': '9d30f9873964.ngrok-free.app', 'x-forwarded-proto': 'https'}
2025-09-06 17:46:54,295 - services.task_queue_service - DEBUG - ‚úÖ Verified Cloud Tasks request from queue: email-tasks
2025-09-06 17:46:54,295 - api.routes.internal_tasks - INFO - üìß Executing email task: email_confirmation_1757195212_5824 (email_confirmation)
2025-09-06 17:46:54,296 - services.gmail_service - INFO - üì§ Sending email to Ben Clark <ben.clark@palace.cl>: Confirmaci√≥n de 9239834
2025-09-06 17:46:54,297 - googleapiclient.discovery - DEBUG - URL being requested: POST https://gmail.googleapis.com/gmail/v1/users/me/messages/send?alt=json
2025-09-06 17:46:54,673 - services.gmail_service - INFO - ‚úÖ Email sent successfully! Message ID: 19920ff1c92fd34a
2025-09-06 17:46:54,674 - api.routes.internal_tasks - INFO - ‚úÖ Email task email_confirmation_1757195212_5824 completed successfully in 379ms
INFO:     34.98.136.133:0 - "POST /api/internal/tasks/email HTTP/1.1" 200 OK